name: Sync All Repos to Gitee

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 */3 * *'  # 每3天执行一次

# MYGITEE_TOKEN 是 gitee 的 token
# MYGITEE_USERNAME 是 gitee 的 用户名
# MYGITHUB_TOKEN 是 github 的 token
jobs:
  sync-to-gitee:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.MYGITHUB_TOKEN }}
      GITEE_TOKEN: ${{ secrets.MYGITEE_TOKEN }}
      GITEE_USERNAME: ${{ secrets.MYGITEE_USERNAME }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup SSH key
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -t rsa gitee.com >> ~/.ssh/known_hosts
        chmod 644 ~/.ssh/known_hosts

    - name: Setup SSH key with ssh-agent
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.MYGITEE_SSH_PRIVATE_KEY }}
        
    - name: Test SSH Connection
      run: ssh -T git@gitee.com || true

    - name: Setup Git and Verify Tokens
      id: verify_tokens
      run: |
        git config --global user.name "github_bot"
        git config --global user.email "github_bot@github.com"
        
        echo "Verifying GitHub Token and counting repositories..."
        github_repos_count=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
          "https://api.github.com/user/repos?per_page=1" -I | grep -i "link:" | grep -o "page=[0-9]*" | tail -1 | cut -d= -f2)
        if [ -z "$github_repos_count" ]; then
          echo "Error: Unable to get GitHub repositories count. Token may be invalid."
          exit 1
        fi
        echo "Found $github_repos_count repositories on GitHub"
        echo "GITHUB_REPOS_COUNT=$github_repos_count" >> $GITHUB_ENV
        
        echo "Verifying Gitee Token and counting repositories..."
        gitee_repos_count=$(curl -s -H "Authorization: token $GITEE_TOKEN" \
          "https://gitee.com/api/v5/user/repos?per_page=1" -I | grep -i "total_count:" | cut -d: -f2 | tr -d ' \r\n')
        if [ -z "$gitee_repos_count" ]; then
          echo "Error: Unable to get Gitee repositories count. Token may be invalid."
          exit 1
        fi
        echo "Found $gitee_repos_count repositories on Gitee"
        echo "GITEE_REPOS_COUNT=$gitee_repos_count" >> $GITHUB_ENV

    - name: Sync Repositories
      run: |
        # 清理函数
        cleanup() {
          local repo_path=$1
          echo "清理临时文件和目录 / Cleaning up temporary files and directories..."
          if [ -d "$repo_path" ]; then
            cd "$repo_path"
            git gc --prune=now
            cd ..
            rm -rf "$repo_path"
          fi
          # 清理所有临时文件
          rm -f /tmp/*.apk /tmp/*.zip /tmp/*.tar.gz /tmp/*.jar 2>/dev/null || true
          echo "✅ 清理完成 / Cleanup completed"
          # 显示剩余磁盘空间
          echo "剩余磁盘空间 / Remaining disk space:"
          df -h /tmp
        }

        # 同步仓库函数
        sync_repo() {
          local repo_name=$1
          local repo_path=$2
          local gitee_repo_exists=$3
          local ret=0
          
          echo "===> 步骤 1: 克隆 GitHub 仓库 / Step 1: Cloning GitHub repository"
          echo "仓库 / Repository: $repo_name"
          
          # 克隆GitHub仓库，使用浅克隆和单分支优化
          git clone --mirror --depth=1 --no-single-branch \
            "https://x-access-token:${GITHUB_TOKEN}@github.com/${repo_name}.git" "$repo_path" || {
            echo "❌ 从 GitHub 克隆仓库失败 / Failed to clone repository from GitHub: $repo_name"
            return 1
          }
          echo "✅ 成功克隆 GitHub 仓库 / Successfully cloned GitHub repository"
          
          # 获取完整历史
          cd "$repo_path"
          git fetch --unshallow || true
          
          if [ "$gitee_repo_exists" = "false" ]; then
            echo "===> 步骤 2: 在 Gitee 上创建新仓库 / Step 2: Creating new repository on Gitee"
            echo "创建私有仓库 / Creating private repository: ${repo_name##*/}"
            # 创建Gitee私有仓库
            local create_response=$(curl -s -X POST -H "Authorization: token $GITEE_TOKEN" \
              "https://gitee.com/api/v5/user/repos" \
              -d "name=${repo_name##*/}&private=true&has_issues=true&has_wiki=true")
            
            if echo "$create_response" | grep -q "error"; then
              echo "❌ 在 Gitee 上创建仓库失败 / Failed to create repository on Gitee: ${repo_name##*/}"
              echo "错误 / Error: $(echo "$create_response" | jq -r '.error // .message')"
              ret=1
            else
              echo "✅ 成功创建 Gitee 仓库 / Successfully created Gitee repository"
            fi
            
            echo "等待仓库创建完成 / Waiting for repository creation to complete..."
            sleep 5
          fi
          
          if [ $ret -eq 0 ]; then
            echo "===> 步骤 3: 推送到 Gitee / Step 3: Pushing to Gitee"
            echo "推送所有分支和标签 / Pushing all branches and tags..."
            
            # 获取所有分支和标签
            local push_failed=false
            echo "获取引用列表 / Getting refs list..."
            
            # 创建临时文件存储结果
            local tmp_result_file=$(mktemp)
            
            # 并行推送所有引用
            git for-each-ref --format='%(refname)' refs/heads/* refs/tags/* | while read ref; do
              {
                echo "推送 / Pushing: $ref"
                if timeout 300 git push -f "git@gitee.com:${GITEE_USERNAME}/${repo_name##*/}.git" "$ref:$ref" > /dev/null 2>&1; then
                  echo "✅ 成功推送 / Successfully pushed: $ref" >> "$tmp_result_file"
                else
                  echo "❌ 推送失败 / Push failed for $ref" >> "$tmp_result_file"
                  echo "failed" >> "$tmp_result_file"
                fi
              } &
              
              # 限制并行数量为5个
              while [ $(jobs -r | wc -l) -ge 5 ]; do
                sleep 1
              done
            done
            
            # 等待所有推送完成
            wait
            
            # 检查结果
            if grep -q "failed" "$tmp_result_file"; then
              echo "❌ 部分引用推送失败 / Some refs failed to push"
              ret=1
            else
              echo "✅ 成功推送所有引用到 Gitee / Successfully pushed all refs to Gitee"
            fi
            
            # 显示所有推送结果
            cat "$tmp_result_file"
            
            # 清理临时文件
            rm -f "$tmp_result_file"
          fi
          
          if [ $ret -eq 0 ]; then
            echo "===> 步骤 4: 同步发布版本和附件 / Step 4: Syncing releases and assets"
            sync_releases "$repo_name" || true
          fi
          
          cd ..
          cleanup "$repo_path"
          return $ret
        }

        # 同步Release附件函数
        sync_releases() {
          local repo_name=$1
          
          echo "检查发布版本 / Checking releases for $repo_name..."
          # 获取GitHub的releases
          local releases=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${repo_name}/releases")
          
          # 检查是否有releases
          if [ "$(echo "$releases" | jq length)" -eq "0" ]; then
            echo "ℹ️ 未找到发布版本 / No releases found for $repo_name"
            return 0
          fi
          
          echo "在 GitHub 上找到 $(echo "$releases" | jq length) 个发布版本 / Found $(echo "$releases" | jq length) release(s) on GitHub"
          
          # 获取Gitee上已存在的releases
          local gitee_releases=$(curl -s -H "Authorization: token $GITEE_TOKEN" \
            "https://gitee.com/api/v5/repos/${GITEE_USERNAME}/${repo_name##*/}/releases?per_page=100")
          local existing_tags=$(echo "$gitee_releases" | jq -r '.[].tag_name' 2>/dev/null || echo "")
          
          # 并行处理releases
          echo "$releases" | jq -c '.[]' | while read -r release; do
            {
              local tag_name=$(echo "$release" | jq -r '.tag_name')
              local name=$(echo "$release" | jq -r '.name // .tag_name')
              local body=$(echo "$release" | jq -r '.body // ""')
              local prerelease=$(echo "$release" | jq -r '.prerelease')
              
              echo "处理发布版本 / Processing release: $tag_name"
              
              # 检查release是否已存在
              if echo "$existing_tags" | grep -q "^${tag_name}$"; then
                echo "ℹ️ 发布版本已存在于 Gitee / Release $tag_name already exists on Gitee"
              else
                process_release "$repo_name" "$tag_name" "$name" "$body" "$prerelease" "$release"
              fi
            } &
            
            # 限制并行数量为3个
            while [ $(jobs -r | wc -l) -ge 3 ]; do
              sleep 1
            done
          done
          
          # 等待所有release处理完成
          wait
          
          return 0
        }

        # 显示同步统计信息
        echo "============================================"
        echo "开始同步过程 / Starting synchronization process"
        echo "GitHub 仓库数量 / GitHub repositories: $GITHUB_REPOS_COUNT"
        echo "Gitee 仓库数量 / Gitee repositories: $GITEE_REPOS_COUNT"
        echo "需要创建的新仓库数量 / New repositories to create: $(($GITHUB_REPOS_COUNT - $GITEE_REPOS_COUNT))"
        echo "============================================"

        # 主程序
        processed=0
        total=$GITHUB_REPOS_COUNT
        page=1
        success_count=0
        failed_count=0
        
        echo "开始仓库同步 / Starting repository synchronization..."
        
        while true; do
          echo "获取第 $page 页仓库 / Fetching page $page of repositories..."
          repos=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/user/repos?per_page=100&page=${page}")
          
          # 检查是否还有仓库
          if [ "$(echo "$repos" | jq length)" -eq "0" ]; then
            echo "没有更多仓库需要处理 / No more repositories to process"
            break
          fi
          
          # 获取Gitee现有仓库列表
          echo "获取 Gitee 仓库列表 / Fetching Gitee repository list..."
          gitee_repos=$(curl -s -H "Authorization: token $GITEE_TOKEN" \
            "https://gitee.com/api/v5/user/repos?per_page=100" | jq -r '.[].name')
          
          # 处理每个仓库
          echo "$repos" | jq -r '.[] | .full_name' | while read -r repo_name; do
            repo_path="/tmp/$(basename "$repo_name")"
            
            echo "----------------------------------------"
            echo "处理第 $((processed + 1)) 个，共 $total 个 / Processing $((processed + 1)) of $total: $repo_name"
            
            # 检查仓库是否已存在于Gitee
            if echo "$gitee_repos" | grep -q "^$(basename "$repo_name")$"; then
              sync_repo "$repo_name" "$repo_path" "true"
              sync_result=$?
            else
              sync_repo "$repo_name" "$repo_path" "false"
              sync_result=$?
            fi
            
            # 根据同步结果更新计数
            if [ $sync_result -eq 0 ]; then
              success_count=$((success_count + 1))
              echo "仓库同步成功 / Repository $repo_name sync succeeded"
            else
              failed_count=$((failed_count + 1))
              echo "仓库同步失败 / Repository $repo_name sync failed"
            fi
            
            processed=$((processed + 1))
            echo "进度 / Progress: $processed/$total repositories processed"
            echo "成功 / Success: $success_count, 失败 / Failed: $failed_count"
            echo "----------------------------------------"
          done
          
          ((page++))
          echo "移至第 $page 页 / Moving to page $page..."
        done
        
        echo "============================================"
        echo "同步完成 / Synchronization completed"
        echo "处理的仓库总数 / Total repositories processed: $processed"
        echo "成功数量 / Successful: $success_count"
        echo "失败数量 / Failed: $failed_count"
        echo "============================================"
        
        # 如果有失败的仓库，返回非零状态码
        [ "$failed_count" -eq 0 ]
